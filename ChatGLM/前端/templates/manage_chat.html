<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对话管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #f0f5ff 0%, #e6e9ff 100%);
        height: 100vh;
        padding: 20px;
        overflow: hidden;
    }

    .container {
        width: 100%;
        max-width: 1200px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 0 auto;
        height: calc(100vh - 40px);
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #4a6bff 0%, #1e40af 100%);
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
        flex-shrink: 0;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 24px;
        font-weight: bold;
    }

    .logo i {
        font-size: 28px;
        color: #ffd166;
    }

    .menu {
        position: relative;
    }

    .menu-btn {
        background: rgba(255, 255, 255, 0.25);
        border: none;
        color: white;
        padding: 10px 18px;
        border-radius: 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        transition: all 0.3s;
        font-size: 16px;
    }

    .menu-btn:hover {
        background: rgba(255, 255, 255, 0.35);
    }

    .dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        width: 200px;
        z-index: 100;
        margin-top: 12px;
        display: none;
        overflow: hidden;
    }

    .dropdown.show {
        display: block;
    }

    .dropdown-item {
        padding: 14px 18px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #333;
        text-decoration: none;
        transition: all 0.2s;
        border-bottom: 1px solid #f0f0f0;
        font-size: 15px;
    }

    .dropdown-item:last-child {
        border-bottom: none;
    }

    .dropdown-item:hover {
        background: #f0f5ff;
        color: #4a6bff;
    }

    .dropdown-item i {
        width: 22px;
        text-align: center;
        font-size: 16px;
        color: #4a6bff;
    }

    .chat-container {
        display: flex;
        gap: 15px; /* 减小间隙 */
        flex: 1;
        min-height: 0;
    }

    /* 左侧边栏 - 拓宽设计 */
    .sidebar {
        width: 320px; /* 增加宽度 */
        background: white;
        border-radius: 15px;
        padding: 20px; /* 减小内边距 */
        box-shadow: 0 5px 15px rgba(74, 107, 255, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e6e9ff;
    }

    .sidebar-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px; /* 减小间距 */
        color: #1e40af;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .history-list {
        list-style: none;
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
    }

    .history-list::-webkit-scrollbar {
        width: 6px;
    }

    .history-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .history-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
    }

    .history-list::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }

    .history-item {
        padding: 14px 16px;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 15px;
        color: #555;
        transition: all 0.2s;
        position: relative;
        background: #f8f9ff;
        border: 1px solid #e6e9ff;
    }

    .history-item:hover {
        background: #eef2ff;
        color: #4a6bff;
        border-color: #c7d2fe;
    }

    .history-item.active {
        background: #e0e7ff;
        color: #4a6bff;
        font-weight: 500;
        border-color: #a5b4fc;
    }

    .history-item i {
        font-size: 14px;
        color: #4a6bff;
    }

    .history-item .time {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        color: #888;
    }

    /* 右侧主区域 - 宽度保持不变 */
    .chat-main {
        flex: 1;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(74, 107, 255, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
        border: 1px solid #e6e9ff;
    }

    .chat-header {
        padding: 18px 25px;
        border-bottom: 1px solid #e6e9ff;
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8f9ff;
        flex-shrink: 0;
    }

    .ai-avatar {
        width: 42px;
        height: 42px;
        background: linear-gradient(135deg, #4a6bff 0%, #1e40af 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        box-shadow: 0 2px 5px rgba(74, 107, 255, 0.3);
    }

    .chat-info {
        flex: 1;
    }

    .chat-title {
        font-weight: bold;
        font-size: 18px;
        color: #1e40af;
    }

    .chat-status {
        font-size: 13px;
        color: #4a6bff;
    }

    .chat-messages {
        flex: 1;
        padding: 25px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: #fafbff;
    }

    .message {
        max-width: 80%;
        padding: 16px 20px;
        border-radius: 20px;
        line-height: 1.5;
        font-size: 15px;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .ai-message {
        align-self: flex-start;
        background: #ffffff;
        border: 1px solid #e0e7ff;
        color: #333;
        border-bottom-left-radius: 5px;
        background: linear-gradient(to bottom right, #f0f5ff, #ffffff);
    }

    .user-message {
        align-self: flex-end;
        background: linear-gradient(135deg, #4a6bff 0%, #1e40af 100%);
        color: white;
        border-bottom-right-radius: 5px;
        box-shadow: 0 2px 8px rgba(74, 107, 255, 0.3);
    }

    .timestamp {
        font-size: 12px;
        color: #777;
        margin-top: 8px;
        text-align: right;
    }

    .ai-message .timestamp {
        text-align: left;
        color: #888;
    }

    .notification {
        position: fixed;
        top: 25px;
        right: 25px;
        background: linear-gradient(135deg, #4a6bff 0%, #1e40af 100%);
        color: white;
        padding: 14px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(74, 107, 255, 0.3);
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.4s ease;
        z-index: 1000;
        font-size: 15px;
    }

    .notification.show {
        transform: translateX(0);
        opacity: 1;
    }

    /* 管理功能区域 */
    .chat-details {
        padding: 20px;
        background: #f8f9ff;
        border-top: 1px solid #e6e9ff;
    }

    .detail-row {
        display: flex;
        margin-bottom: 15px;
    }

    .detail-label {
        width: 120px;
        font-weight: bold;
        color: #1e40af;
    }

    .detail-value {
        flex: 1;
        color: #333;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .action-btn {
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .delete-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #c92c2c 100%);
        color: white;
        border: none;
        box-shadow: 0 2px 8px rgba(201, 44, 44, 0.3);
    }

    .delete-btn:hover {
        background: linear-gradient(135deg, #ff5252 0%, #b02525 100%);
    }

    .no-conversation {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 40px;
        text-align: center;
        color: #777;
    }

    .no-conversation i {
        font-size: 48px;
        margin-bottom: 20px;
        color: #e0e7ff;
    }

    .no-conversation p {
        font-size: 18px;
        margin-bottom: 10px;
    }

    .no-conversation .hint {
        font-size: 14px;
        color: #999;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
    }

    .user-avatar {
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #4a6bff 0%, #1e40af 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
    }

    /* 搜索区域优化 */
    .search-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px; /* 减小间距 */
        background: none;
        padding: 12px 15px; /* 减小内边距 */
        border-radius: 10px;
        border: none;
        margin-left: -15px; /* 添加负边距实现左移 */
    }

    .search-input {
        flex: 1;
        padding: 12px 18px;
        border: 1px solid #e0e7ff;
        border-radius: 25px;
        outline: none;
        font-size: 15px;
        transition: all 0.3s;
        background: white;
    }

    .search-input:focus {
        border-color: #4a6bff;
        box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.1);
    }

    .search-button {
        margin-left: 10px; /* 减小间距 */
        padding: 12px 18px; /* 减小内边距 */
        background: linear-gradient(135deg, #4a6bff 0%, #1e40af 100%);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        font-size: 15px;
        box-shadow: 0 2px 8px rgba(74, 107, 255, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-button:hover {
        background: linear-gradient(135deg, #3a5bef 0%, #0d2e9e 100%);
    }

    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #777;
        background: #f8f9ff;
        border-radius: 12px;
        border: 1px dashed #e0e7ff;
        margin-top: 20px;
    }

    .no-results i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #e0e7ff;
    }

    .no-results h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: #4a6bff;
    }

    .no-results p {
        font-size: 15px;
        color: #999;
        max-width: 300px;
        margin: 0 auto;
        line-height: 1.5;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-comments"></i>
                <span>对话管理系统</span>
            </div>
            <div class="menu">
                <button class="menu-btn" onclick="window.location.href='{{ url_for('manager_page') }}'">
                    <i class="fas fa-arrow-left"></i>
                    <span>返回管理</span>
                </button>
            </div>
        </div>

        <div class="chat-container">
            <div class="sidebar">
                <div class="sidebar-title">
                    <span>所有用户对话</span>
                </div>

                <!-- 搜索区域 -->
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="搜索对话..." value="{{ search_term }}">
                    <button class="search-button" id="search-button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <ul class="history-list">
                    {% for conv in conversations %}
                    <li class="history-item {% if conv.chat_id == active_chat_id %}active{% endif %}"
                        onclick="loadChat({{ conv.chat_id }})">
                        <div class="user-avatar">
                            {{ conv.user_name[0]|upper }}
                        </div>
                        <div class="chat-info">
                            <div class="chat-title">{{ conv.title }}</div>
                            <div class="chat-time">{{ conv.time_label }}</div>
                        </div>
                    </li>
                    {% endfor %}

                    {% if not conversations and search_term %}
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <p>没有找到匹配的对话</p>
                        <p class="hint">尝试使用其他搜索词</p>
                    </div>
                    {% endif %}
                </ul>
            </div>

            <div class="chat-main">
                {% if active_chat %}
                <div class="chat-header">
                    <div class="ai-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-title">{{ active_chat.title }}</div>
                        <div class="chat-status">对话ID: {{ active_chat.chat_id }}</div>
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    {% for msg in messages %}
                    <div class="message {% if msg.message_sender_type == 1 %}ai-message{% else %}user-message{% endif %}">
                        {{ msg.message_text }}
                        <div class="timestamp">
                            {{ msg.message_time.strftime('%H:%M') }}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="chat-details">
                    <div class="detail-row">
                        <div class="detail-label">创建时间:</div>
                        <div class="detail-value">{{ active_chat.create_time.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">最后活动:</div>
                        <div class="detail-value">{{ active_chat.last_time.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">消息数量:</div>
                        <div class="detail-value">{{ messages|length }}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">用户信息:</div>
                        <div class="detail-value">
                            <div class="user-info">
                                <div class="user-avatar">
                                    {{ active_chat.user_name[0]|upper }}
                                </div>
                                <span>{{ active_chat.user_name }} (ID: {{ active_chat.user_id }})</span>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn delete-btn" onclick="deleteChat({{ active_chat.chat_id }})">
                            <i class="fas fa-trash-alt"></i>
                            <span>删除对话</span>
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="no-conversation">
                    <i class="fas fa-comment-slash"></i>
                    <p>请从左侧选择对话</p>
                    <p class="hint">选择对话后，您可以查看详细内容和进行管理操作</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        对话已成功删除！
    </div>

    <script>
        // 全局函数定义
        function loadChat(chatId) {
            const searchTerm = document.getElementById('search-input').value;
            if (searchTerm) {
                window.location.href = `/manage_chat?chat_id=${chatId}&search=${encodeURIComponent(searchTerm)}`;
            } else {
                window.location.href = `/manage_chat?chat_id=${chatId}`;
            }
        }

        function deleteChat(chatId) {
            if (confirm(`确定要删除此对话吗？此操作不可恢复！`)) {
                fetch(`/delete_chat/${chatId}`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        showNotification('对话已成功删除！');
                        setTimeout(() => {
                            window.location.href = '/manage_chat';
                        }, 1500);
                    } else {
                        showNotification('删除失败，请重试');
                    }
                })
                .catch(error => {
                    console.error('删除对话失败:', error);
                    showNotification('删除失败，请重试');
                });
            }
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');

            // 自动滚动到底部
            function scrollToBottom() {
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            scrollToBottom();

            // 搜索功能
            searchButton.addEventListener('click', function() {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    window.location.href = `/manage_chat?search=${encodeURIComponent(searchTerm)}`;
                } else {
                    window.location.href = '/manage_chat';
                }
            });

            // 按回车键搜索
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchButton.click();
                }
            });
        });
    </script>
</body>
</html>